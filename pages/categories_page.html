<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Categories - Premium Fresh Groceries | DealDrop</title>
    <link rel="stylesheet" href="../css/main.css">
    
<body class="bg-background text-text-primary">
     <!-- Navigation Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-background/95 backdrop-blur-sm border-b border-surface">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between">

           <!-- BIG Logo (Perfect Fit, Left Aligned) -->
        <div class="flex items-center space-x-3 shrink-0">
            <img src="https://i.postimg.cc/Hsx8pxHb/Screenshot-2025-11-13-165233.png"
                 alt="DealDrop Logo"
                 class="h-16 w-auto object-contain block select-none" /> <span class="text-xl md:text-2xl font-bold text-white tracking-wide hover:text-[#4de8ba] transition-colors duration-300">
    DealDrop
  </span>
        </div>

                <!-- Search Bar -->
<div class="hidden md:flex flex-1 max-w-2xl mx-8">
    <div class="relative w-full">

        <!-- Input -->
        <input type="text" 
            placeholder="Search for fresh produce, organic foods..."
            id="searchInput"
            class="w-full pl-14 pr-4 py-3 rounded-full bg-[#082219] text-white placeholder-gray-400 
                   border border-[#0f4f35]/60 shadow-[0_0_8px_rgba(0,255,170,0.15)]
                   focus:border-[#14f5a3] focus:shadow-[0_0_18px_rgba(20,245,163,0.45)]
                   transition-all duration-300 outline-none">

        <!-- Search Icon -->
        <svg 
            class="absolute left-5 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[#4de8ba]"
            fill="none" stroke="currentColor" 
            viewBox="0 0 24 24"
        >
            <path 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                stroke-width="2" 
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
        </svg>

        <!-- Search Suggestions Dropdown -->
        <div 
            id="searchSuggestions" 
            class="absolute top-full left-0 right-0 bg-[#0b2d22] border border-[#124736]/50 
                   rounded-xl mt-2 shadow-[0_0_20px_rgba(18,245,159,0.15)] hidden backdrop-blur-xl"
        >
            <div class="p-4 text-white">
                <div class="text-sm text-gray-300 mb-3 font-semibold tracking-wide">Popular Searches</div>

                <div class="space-y-2">

                    <!-- Suggestion 1 -->
                    <div class="flex items-center space-x-3 p-2 rounded-lg cursor-pointer
                                hover:bg-[#103829] transition-colors duration-200">
                        <img 
                            src="https://images.unsplash.com/photo-1675324918825-cd13b33a35b6" 
                            alt="Fresh organic tomatoes" 
                            class="w-8 h-8 rounded object-cover"
                        >
                        <span class="text-gray-100">Organic Tomatoes</span>
                    </div>

                    <!-- Suggestion 2 -->
                    <div class="flex items-center space-x-3 p-2 rounded-lg cursor-pointer
                                hover:bg-[#103829] transition-colors duration-200">
                        <img 
                            src="https://images.unsplash.com/photo-1676454954482-3a7d43f780e3" 
                            alt="Fresh leafy greens and vegetables" 
                            class="w-8 h-8 rounded object-cover"
                        >
                        <span class="text-gray-100">Fresh Greens</span>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center space-x-6">
                <a href="homepage.html" class="text-secondary font-semibold">Home</a>

                <a href="categories_page.html" class="text-text-secondary hover:text-secondary transition-colors duration-300">
                    Categories
                </a>

                <!-- Cart Icon with Badge -->
                <a href="shopping_cart.html" class="relative text-text-secondary hover:text-secondary transition-colors duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width="2" 
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"
                        ></path>
                    </svg>
                    <span class="absolute -top-2 -right-2 bg-secondary text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-semibold">3</span>
                </a>

                <!-- Account -->
                <a href="user_account_dashboard.html" class="text-text-secondary hover:text-secondary transition-colors duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width="2" 
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        ></path>
                    </svg>
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden text-text-primary" id="mobileMenuBtn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path 
                        stroke-linecap="round" 
                        stroke-linejoin="round" 
                        stroke-width="2" 
                        d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
            </button>

        </nav>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="md:hidden bg-surface border-t border-surface hidden">
            <div class="px-4 py-4 space-y-4">

                <div class="relative">
                    <input 
                        type="text" 
                        placeholder="Search products..." 
                        class="input-field w-full pl-10 pr-4 py-2"
                    >
                    <svg 
                        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-text-secondary" 
                        fill="none" stroke="currentColor" 
                        viewBox="0 0 24 24"
                    >
                        <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width="2" 
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path>
                    </svg>
                </div>

                <a href="homepage.html" class="block text-secondary font-semibold py-2">Home</a>
                <a href="categories_page.html" class="block text-text-secondary py-2">Categories</a>
                <a href="shopping_cart.html" class="block text-text-secondary py-2">Cart (3)</a>
                <a href="user_account_dashboard.html" class="block text-text-secondary py-2">Account</a>

            </div>
        </div>

    </header>

<!-- ===== START: Category Content (paste between header and footer) ===== -->

<!-- Breadcrumb + Title + Controls -->
<section class="pt-28 pb-6 bg-gradient-to-r from-black via-neutral-900 to-black shadow-inner animate-fadeUp">
  <div class="container mx-auto px-4">
    <nav class="flex items-center space-x-2 text-sm mb-4">
      <a href="homepage.html" class="text-text-secondary hover:text-secondary transition-colors duration-300">Home</a>
      <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
      <span class="text-secondary font-semibold tracking-wide">Categories</span>
    </nav>

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold tracking-wide text-white">Fresh Produce</h1>
        <p id="productCount" class="text-text-secondary mt-1">Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span> products</p>
      </div>

      <div class="flex items-center space-x-3">
        <div class="hidden sm:flex items-center bg-neutral-900/60 rounded-lg px-3 py-1 shadow-inner">
          <label class="mr-3 text-text-secondary">Search</label>
          <input id="searchBar" type="text" placeholder="Search products..." class="input-field bg-transparent border-none outline-none text-white pl-0 pr-3">
        </div>

        <!-- Filters button (opens drawer) -->
        <button id="openFilter" class="btn-secondary flex items-center space-x-2 px-4 py-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707L13 14.707V21l-2-1v-6.293L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
          <span>Filters</span>
        </button>

        <!-- Sort -->
        <select id="sortSelect" class="input-field cursor-pointer">
          <option value="pop">Sort by Popularity</option>
          <option value="low">Price: Low to High</option>
          <option value="high">Price: High to Low</option>
          <option value="new">Newest Arrivals</option>
          <option value="rating">Customer Rating</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- Main -->
<main class="container mx-auto px-4 py-10">
  <div class="flex gap-10">

    <!-- Product Grid (full width; filter drawer is separate) -->
    <div class="flex-1">
      <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

      <div class="text-center mt-12">
        <button id="loadMore" class="btn-secondary px-8 py-3">Load More Products</button>
      </div>
    </div>
  </div>
</main>

<!-- Right filter drawer (hidden by default) -->
<aside id="filterDrawer"
  class="fixed right-0 top-[80px] h-[calc(100vh-100px)] w-80 bg-neutral-900/95 backdrop-blur-md border-l border-neutral-800 rounded-l-xl p-6 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-auto">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-xl font-semibold text-secondary">Filters</h3>
    <button id="closeFilter" class="p-2 rounded hover:bg-neutral-800">
      ‚úï
    </button>
  </div>

  <div class="space-y-6">

    <!-- Categories -->
    <div>
      <h4 class="font-semibold mb-3">Category</h4>
      <div class="space-y-2">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-cat" value="veg">
          <span>Veg</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-cat" value="nonveg">
          <span>Non-Veg</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-cat" value="dairy">
          <span>Dairy</span>
        </label>
      </div>
    </div>

    <!-- Tags -->
    <div>
      <h4 class="font-semibold mb-3">Tags</h4>
      <div class="space-y-2">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-tag" value="organic">
          <span>Organic</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-tag" value="fresh">
          <span>Fresh</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-tag" value="premium">
          <span>Premium</span>
        </label>
      </div>
    </div>

    <!-- Brands -->
    <div>
      <h4 class="font-semibold mb-3">Brands</h4>
      <div class="space-y-2">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-brand" value="farmfresh">
          <span>Farm Fresh Co.</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-brand" value="organicvalley">
          <span>Organic Valley</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" class="filter-brand" value="greenharvest">
          <span>Green Harvest</span>
        </label>
      </div>
    </div>

    <!-- Price range (double slider) -->
    <div>
      <h4 class="font-semibold mb-3">Price Range (‚Çπ)</h4>
      <div class="text-sm text-text-secondary mb-2">Min: <span id="priceMinDisplay">0</span> ‚Äî Max: <span id="priceMaxDisplay">1000</span></div>

      <div class="relative h-8">
        <input id="rangeMin" type="range" min="0" max="2000" step="1" value="0" class="absolute left-0 right-0 w-full h-2 appearance-none">
        <input id="rangeMax" type="range" min="0" max="2000" step="1" value="1000" class="absolute left-0 right-0 w-full h-2 appearance-none">
      </div>
    </div>

    <!-- Reset / Apply -->
    <div class="flex gap-3">
      <button id="resetFilters" class="btn-secondary flex-1">Reset</button>
      <button id="applyFilters" class="btn-primary flex-1">Apply</button>
    </div>
  </div>
</aside>

<!-- Mini Cart (slides in from right) -->
<div id="miniCart" class="fixed top-24 right-4 bg-neutral-900/95 backdrop-blur-md border border-neutral-800 rounded-xl p-4 w-80 transform translate-x-full transition-transform duration-300 z-60 shadow-xl">
  <div class="flex items-center justify-between mb-3">
    <h4 class="font-semibold">Cart</h4>
    <button id="closeMiniCart" class="p-1 hover:bg-neutral-800 rounded">‚úï</button>
  </div>
  <div id="miniCartItems" class="space-y-3 max-h-56 overflow-auto"></div>
  <div class="border-t border-neutral-800 pt-3 mt-3">
    <div class="flex justify-between mb-3">
      <span class="font-semibold">Total</span>
      <span id="miniCartTotal" class="font-bold text-secondary">‚Çπ0.00</span>
    </div>
    <a href="shopping_cart.html" class="btn-primary w-full text-center">Go to Cart</a>
  </div>
</div>

<!-- ===== Styles & Scripts (paste together) ===== -->
<style>
  /* Animations */
  @keyframes fadeUp { from { opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
  @keyframes fadeUpSlow { from { opacity:0; transform:translateY(40px);} to {opacity:1; transform:translateY(0);} }
  @keyframes slideLeft { from { opacity:0; transform:translateX(-30px);} to {opacity:1; transform:translateX(0);} }
  @keyframes slideRight { from { opacity:0; transform:translateX(30px);} to {opacity:1; transform:translateX(0);} }

  .animate-fadeUp { animation: fadeUp 0.7s ease-out forwards; }
  .animate-fadeUpSlow { animation: fadeUpSlow 1s ease-out forwards; }
  .animate-slideLeft { animation: slideLeft 0.7s ease-out forwards; }
  .animate-slideRight { animation: slideRight 0.8s ease-out forwards; }

  /* Drawer helpers */
  #filterDrawer { box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
  #filterDrawer::-webkit-scrollbar { width: 8px; }
  #filterDrawer::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 8px; }

  /* Range double-track visual */
  input[type="range"] { -webkit-appearance:none; background:transparent; }
  input[type="range"]::-webkit-slider-runnable-track { height:6px; background:rgba(255,255,255,0.06); border-radius:999px; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#d4a017; margin-top:-6px; box-shadow:0 2px 6px rgba(0,0,0,0.5); cursor:pointer; }
  /* make thumbs visible above each other */
  #rangeMin { z-index:3; }
  #rangeMax { z-index:2; }

  /* Product card tweaks (keeps your current style) */
  .product-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:12px; box-shadow: 0 6px 20px rgba(2,6,2,0.45); border: 1px solid rgba(255,255,255,0.03); }
  .product-card img { border-radius:10px; }
  .product-meta { display:flex; align-items:center; justify-content:space-between; gap:8px; }

  /* Buttons */
  .btn-primary { background: linear-gradient(90deg,#d4a017,#ffdc7a); color: #000; padding:10px 12px; border-radius:8px; font-weight:600; }
  .btn-secondary { background: rgba(255,255,255,0.03); color:#d1d5db; padding:8px 10px; border-radius:8px; font-weight:600; border:1px solid rgba(255,255,255,0.03); }

  /* Utility */
  .text-text-secondary { color: #9aa4a0; }
  .text-secondary { color: #d4a017; }
  .bg-neutral-900 { background-color:#081512; }
  .bg-neutral-900\/60 { background-color: rgba(8,21,18,0.6); }
  .shadow-inner { box-shadow: inset 0 4px 30px rgba(0,0,0,0.6); }

  /* Responsive small fixes */
  @media (max-width: 768px) {
    #filterDrawer { width: 92vw; top: 70px; right: 0; }
  }
</style>

<!-- ===== END: Category Content ===== -->

<!-- ====== END: Paste this between your header and footer ====== -->

    <!-- Footer -->
<footer class="relative bg-gradient-to-br from-[#0a0a0a] via-[#111111] to-[#1a1a1a] text-gray-300 py-20 overflow-hidden">
  <!-- Subtle background glow -->
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(18,245,159,0.15),transparent_70%)]"></div>
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(18,245,159,0.1),transparent_70%)]"></div>

  <div class="relative z-10 container mx-auto px-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-gray-700 pb-12">
      
      <!-- Company Info -->
      <div>
        <div class="flex items-center space-x-3 mb-6">
          <div class="w-12 h-12 bg-[#12f59f] rounded-full flex items-center justify-center text-black font-bold text-xl shadow-[0_0_20px_rgba(18,245,159,0.5)]">D</div>
          <span class="text-3xl font-bold text-white">DealDrop</span>
        </div>
        <p class="text-gray-400 mb-6 leading-relaxed">
          Freshness delivered. Experience premium groceries with the simplicity and speed of DealDrop.
        </p>

        <!-- Social Media Icons -->
        <div class="flex space-x-5">
          <!-- Facebook -->
          <a href="#" class="group transition-all duration-300" aria-label="Facebook">
            <svg class="w-7 h-7 text-gray-400 group-hover:text-[#12f59f] transition" fill="currentColor" viewBox="0 0 24 24">
              <path d="M22.675 0h-21.35C.596 0 0 .592 0 1.324v21.352C0 23.406.596 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.658-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.314h3.587l-.467 3.622h-3.12V24h6.116C23.404 24 24 23.406 24 22.676V1.324C24 .592 23.404 0 22.675 0z"/>
            </svg>
          </a>

          <!-- Instagram -->
          <a href="#" class="group transition-all duration-300" aria-label="Instagram">
            <svg class="w-7 h-7 text-gray-400 group-hover:text-[#f56040] transition" fill="currentColor" viewBox="0 0 24 24">
              <path d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5A4.25 4.25 0 0 0 20.5 16.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5zm8.75 2.25a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5zM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 1.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Quick Links -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Quick Links</h3>
        <ul class="space-y-3">
          <li><a href="homepage.html" class="hover:text-[#12f59f] transition">Home</a></li>
          <li><a href="categories_page.html" class="hover:text-[#12f59f] transition">Categories</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">About Us</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Contact</a></li>
        </ul>
      </div>

      <!-- Customer Service -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Customer Service</h3>
        <ul class="space-y-3">
          <li><a href="#" class="hover:text-[#12f59f] transition">Help Center</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Shipping Info</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Returns</a></li>
          <li><a href="user_account_dashboard.html" class="hover:text-[#12f59f] transition">My Account</a></li>
        </ul>
      </div>

      <!-- Contact Info -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Contact Info</h3>
        <ul class="space-y-3">
          <li>üìû <span class="text-gray-400">91+8169963185</span></li>
          <li>‚úâÔ∏è <span class="text-gray-400">botfather@gmail.com</span></li>
          <li>üìç <span class="text-gray-400">Kandivali (E),Mumbai</span></li>
        </ul>
      </div>
    </div>

    <!-- Bottom Section -->
    <div class="pt-8 text-center text-sm text-gray-500">
      <p>¬© 2025 DealDrop ‚Äî Designed with üíö Developed by ~Sahil .</p>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../js/dealdrop.js"></script>
<script>
 

(async () => {
  // must have supabaseClient from dealdrop.js
  if (typeof supabaseClient === "undefined") {
    console.error("supabaseClient not found. Make sure dealdrop.js is loaded.");
    return;
  }

  const api = supabaseClient;

  // ---------- DOM helpers ----------
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const formatINR = (n) =>
    "‚Çπ" +
    Number(n || 0).toLocaleString("en-IN", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  const safe = (v) => (v == null ? "" : String(v));

  // ---------- Elements ----------
  const productGrid = $("#productGrid");
  if (!productGrid) {
    console.warn("Category script: #productGrid not found");
    return;
  }

  const loadMoreBtn = $("#loadMore");
  const openFilterBtn = $("#openFilter");
  const closeFilterBtn = $("#closeFilter");
  const filterDrawer = $("#filterDrawer");
  const applyFiltersBtn = $("#applyFilters");
  const resetFiltersBtn = $("#resetFilters");
  const rangeMin = $("#rangeMin");
  const rangeMax = $("#rangeMax");
  const priceMinDisplay = $("#priceMinDisplay");
  const priceMaxDisplay = $("#priceMaxDisplay");
  const searchBar = $("#searchBar");
  const sortSelect = $("#sortSelect");
  const visibleCount = $("#visibleCount");
  const totalCount = $("#totalCount");
  const miniCart = $("#miniCart");
  const miniCartItemsEl = $("#miniCartItems");
  const miniCartTotalEl = $("#miniCartTotal");
  const cartCountBadge =
    $("#cartCount") || $("#cart-count") || document.querySelector(".cart-badge");
  const closeMiniBtn = $("#closeMiniCart");

  // ---------- State ----------
  let allProducts = []; // fully from DB
  let lastRendered = [];
  let perPage = 12;
  let page = 1;

  let currentUser = null;
  let currentCartId = null;
  let miniCartItems = [];

  // ---------- Auth / Cart helpers ----------

  async function loadCurrentUser() {
    const { data, error } = await api.auth.getUser();
    if (error) {
      console.warn("getUser error:", error.message);
      return;
    }
    currentUser = data?.user || null;
  }

  async function ensureCart() {
    if (!currentUser) return null;
    if (currentCartId) return currentCartId;

    // find existing cart
    const { data: existing, error } = await api
      .from("user_cart")
      .select("id")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (error) {
      console.warn("cart select error:", error.message);
    }

    if (existing) {
      currentCartId = existing.id;
      return currentCartId;
    }

    // create new cart
    const { data: inserted, error: insertErr } = await api
      .from("user_cart")
      .insert({ user_id: currentUser.id })
      .select("id")
      .single();

    if (insertErr) {
      console.error("create cart error:", insertErr.message);
      return null;
    }

    currentCartId = inserted.id;
    return currentCartId;
  }

  async function reloadMiniCart() {
    if (!currentUser) {
      // if not logged in, clear display
      miniCartItems = [];
      renderMiniCart();
      updateHeaderBadge();
      return;
    }

    const cartId = await ensureCart();
    if (!cartId) return;

    const { data, error } = await api
      .from("user_cart_items")
      .select("id, quantity, products ( id, name, price, image_url )")
      .eq("cart_id", cartId);

    if (error) {
      console.error("cart_items fetch error:", error.message);
      return;
    }

    miniCartItems = (data || []).map((row) => ({
      id: row.id,
      quantity: row.quantity,
      productId: row.products?.id,
      name: row.products?.name,
      price: row.products?.price,
      image: row.products?.image_url,
    }));
    


    renderMiniCart();

    updateHeaderBadge();
    

  }

  async function addToCart(productId) {
    if (!currentUser) {
      alert("Please login to add items to your cart.");
      window.location.href = "login.html";
      return;
    }

    const cartId = await ensureCart();
    if (!cartId) return;

    // check if item already exists
    const { data: existing, error } = await api
      .from("user_cart_items")
      .select("id, quantity")
      .eq("cart_id", cartId)
      .eq("product_id", productId)
      .maybeSingle();

    if (error) {
      console.warn("user_cart_items lookup error:", error.message);
    }

    if (existing) {
      // update quantity
      const { error: updErr } = await api
        .from("user_cart_items")
        .update({ quantity: existing.quantity + 1 })
        .eq("id", existing.id);

      if (updErr) {
        console.error("user_cart_items update error:", updErr.message);
      }
    } else {
      // insert new
      const { error: insErr } = await api.from("user_cart_items").insert({
        cart_id: cartId,
        product_id: productId,
        quantity: 1,
      });

      if (insErr) {
        console.error("user_cart_items insert error:", insErr.message);
      }
    }

    await reloadMiniCart();
    openMini();
  }

  async function removeCartItem(itemId) {
    const { error } = await api.from("user_cart_items").delete().eq("id", itemId);
    if (error) {
      console.error("Remove item error:", error.message);
      return;
    }
    await reloadMiniCart();
  }

  // ---------- UI helpers ----------

  function updateHeaderBadge() {
    const count = miniCartItems.reduce(
      (sum, it) => sum + Number(it.quantity || 0),
      0
    );
    if (cartCountBadge) cartCountBadge.textContent = count;
    $$(".absolute.-top-2.-right-2, .w-5.h-5").forEach((el) => {
      try {
        el.textContent = count;
      } catch {}
    });
  }

  function renderMiniCart() {
    if (!miniCartItemsEl || !miniCartTotalEl) return;

    miniCartItemsEl.innerHTML = "";
    let total = 0;

    if (!miniCartItems.length) {
      miniCartItemsEl.innerHTML =
        '<div class="text-text-secondary">Your cart is empty.</div>';
    } else {
      miniCartItems.forEach((it) => {
        const qty = Number(it.quantity || 1);
        total += Number(it.price || 0) * qty;

        const row = document.createElement("div");
        row.className = "flex items-center gap-3 mb-3";
        row.innerHTML = `
          <div class="w-12 h-12 rounded overflow-hidden bg-neutral-800">
            <img src="${safe(it.image)}" alt="${safe(it.name)}"
                 class="w-full h-full object-cover" />
          </div>
          <div class="flex-1">
            <div class="text-sm font-semibold">${safe(it.name)}</div>
            <div class="text-xs text-text-secondary">
              ${formatINR(it.price)} √ó ${qty}
            </div>
          </div>
          <button class="text-xs text-text-secondary remove-mini" data-id="${it.id}">
            Remove
          </button>
        `;
        miniCartItemsEl.appendChild(row);
      });
    }

    miniCartTotalEl.textContent = formatINR(total);

    // delegate remove
    miniCartItemsEl.onclick = (ev) => {
      const btn = ev.target.closest(".remove-mini");
      if (!btn) return;
      const id = Number(btn.dataset.id);
      if (!id) return;
      removeCartItem(id);
    };
  }

  function openMini() {
    if (miniCart) miniCart.classList.remove("translate-x-full");
  }

  function closeMini() {
    if (miniCart) miniCart.classList.add("translate-x-full");
  }

  if (closeMiniBtn) closeMiniBtn.addEventListener("click", closeMini);

  // ---------- Product rendering from DB ----------

  function createCard(p) {
    const div = document.createElement("div");
    div.className =
      "card group cursor-pointer transform hover:scale-105 transition-all duration-300 product-card";
    div.dataset.id = p.id;
    const mainTag = p.tags && p.tags.length ? p.tags[0] : "";
    const isOrganic = (p.tags || []).includes("organic");

    div.innerHTML = `
      <div class="relative overflow-hidden rounded-lg mb-4">
        <img src="${safe(p.image)}" alt="${safe(p.name)}"
             class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-300"
             loading="lazy" />
        <div class="absolute top-2 left-2">
          <span class="bg-secondary text-black text-xs font-semibold px-2 py-1 rounded">
            ${isOrganic ? "Organic" : mainTag}
          </span>
        </div>
      </div>
      <div class="space-y-2 px-1 pb-2">
        <h3 class="font-semibold text-text-primary group-hover:text-secondary transition-colors duration-300">
          ${safe(p.name)}
        </h3>
        <div class="flex items-center space-x-2">
          <div class="flex text-secondary text-sm">
            ${"‚òÖ".repeat(Math.round(p.rating || 4))}
          </div>
          <span class="text-text-secondary text-sm">
            (${Math.floor(Math.random() * 300) + 20})
          </span>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="text-xl font-bold text-secondary">
              ${formatINR(p.price)}
            </span>
          </div>
          <span class="text-xs text-text-secondary">${safe(p.unit)}</span>
        </div>
        <button class="btn-primary w-full add-to-cart" data-id="${p.id}">
          Add to Cart
        </button>
      </div>
    `;
    return div;
  }

  let observer;
  function observeCards() {
    if (observer) observer.disconnect();
    observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((en) => {
          if (en.isIntersecting) en.target.classList.add("animate-fadeUp");
        });
      },
      { threshold: 0.12 }
    );
    $$(".product-card", productGrid).forEach((c) => observer.observe(c));
  }

  function onAddClick(e) {
    e.stopPropagation();
    const id = Number(e.currentTarget.dataset.id);
    if (!id) return;
    const btn = e.currentTarget;
    const prev = btn.textContent;

    addToCart(id).then(() => {
      btn.textContent = "Added!";
      btn.disabled = true;
      setTimeout(() => {
        btn.textContent = prev;
        btn.disabled = false;
      }, 800);
    });
  }

  function renderProducts(arr, pageNum = 1) {
    productGrid.innerHTML = "";
    const end = pageNum * perPage;
    const slice = arr.slice(0, end);
    slice.forEach((p) => productGrid.appendChild(createCard(p)));

    if (visibleCount) visibleCount.textContent = Math.min(arr.length, end);
    if (totalCount) totalCount.textContent = arr.length;

    if (loadMoreBtn)
      loadMoreBtn.style.display = arr.length > end ? "inline-block" : "none";

    $$(".add-to-cart", productGrid).forEach((btn) => {
      btn.removeEventListener("click", onAddClick);
      btn.addEventListener("click", onAddClick);
    });

    observeCards();
  }

  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", () => {
      page++;
      renderProducts(lastRendered, page);
    });
  }

  // ---------- Filters / Sorting ----------

  function getSelected(selector) {
    return $$(selector).filter((ch) => ch.checked).map((ch) => ch.value);
  }

  function getFilterState() {
    const cats = getSelected(".filter-cat"); // veg / nonveg / dairy
    const tags = getSelected(".filter-tag");
    const brands = getSelected(".filter-brand");
    const min = Math.min(
      Number(rangeMin?.value || 0),
      Number(rangeMax?.value || 0)
    );
    const max = Math.max(
      Number(rangeMin?.value || 0),
      Number(rangeMax?.value || 2000)
    );
    const search = (searchBar?.value || "").trim().toLowerCase();
    const sort = sortSelect?.value || "pop";
    return { cats, tags, brands, priceMin: min, priceMax: max, search, sort };
  }

  function applyFilterLogic(products, state) {
    return products.filter((p) => {
      if (state.cats.length && !state.cats.includes(p.category)) return false;

      if (
        state.tags.length &&
        !state.tags.some((t) => (p.tags || []).includes(t))
      )
        return false;

      if (
        state.brands.length &&
        state.brands.indexOf(p.brandKey) === -1
      )
        return false;

      if (p.price < state.priceMin || p.price > state.priceMax) return false;

      if (state.search) {
        const hay = (
          p.name +
          " " +
          (p.tags || []).join(" ") +
          " " +
          p.brandRaw +
          " " +
          p.category
        ).toLowerCase();
        if (!hay.includes(state.search)) return false;
      }

      return true;
    });
  }

  function sortProducts(products, key) {
  let arr = products.slice();

  switch (key) {
    case "low":
      arr.sort((a, b) => a.price - b.price);
      break;

    case "high":
      arr.sort((a, b) => b.price - a.price);
      break;

    case "new":
      arr.sort((a, b) => b.id - a.id);
      break;

    case "rating":
      arr.sort((a, b) => (b.rating || 0) - (a.rating || 0));
      break;

    // ‚≠ê POPULARITY = VEG PRODUCTS FIRST
    case "pop":
    default:
      arr.sort((a, b) => {
        const aIsVeg = a.category_slug === "veg" || a.category === "veg";
        const bIsVeg = b.category_slug === "veg" || b.category === "veg";

        if (aIsVeg && !bIsVeg) return -1;
        if (!aIsVeg && bIsVeg) return 1;

        // fallback: newest first
        return b.id - a.id;
      });
      break;
  }

  return arr;
}


  function syncRangeDisplay() {
    if (!priceMinDisplay || !priceMaxDisplay || !rangeMin || !rangeMax) return;
    let min = Number(rangeMin.value || 0);
    let max = Number(rangeMax.value || 0);
    if (min > max) [min, max] = [max, min];
    priceMinDisplay.textContent = min;
    priceMaxDisplay.textContent = max;
  }

  if (rangeMin && rangeMax) {
    rangeMin.addEventListener("input", syncRangeDisplay);
    rangeMax.addEventListener("input", syncRangeDisplay);
    syncRangeDisplay();
  }

  if (resetFiltersBtn) {
    resetFiltersBtn.addEventListener("click", () => {
      $$(".filter-cat, .filter-tag, .filter-brand").forEach(
        (c) => (c.checked = false)
      );
      if (rangeMin) rangeMin.value = rangeMin.min || 0;
      if (rangeMax) rangeMax.value = rangeMax.max || 2000;
      syncRangeDisplay();
      if (searchBar) searchBar.value = "";
      if (sortSelect) sortSelect.value = "pop";
      page = 1;
      lastRendered = sortProducts(allProducts, "pop");
      renderProducts(lastRendered, page);
    });
  }

  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener("click", () => {
      page = 1;
      const st = getFilterState();
      let filtered = applyFilterLogic(allProducts, st);
      filtered = sortProducts(filtered, st.sort);
      lastRendered = filtered;
      renderProducts(lastRendered, page);
      if (filterDrawer)
        filterDrawer.classList.add("translate-x-full");
    });
  }

  if (openFilterBtn)
    openFilterBtn.addEventListener("click", () => {
      if (filterDrawer)
        filterDrawer.classList.remove("translate-x-full");
    });
  if (closeFilterBtn)
    closeFilterBtn.addEventListener("click", () => {
      if (filterDrawer)
        filterDrawer.classList.add("translate-x-full");
    });

  document.addEventListener("click", (ev) => {
    if (!filterDrawer) return;
    if (filterDrawer.classList.contains("translate-x-full")) return;
    const inside =
      filterDrawer.contains(ev.target) ||
      (openFilterBtn && openFilterBtn.contains(ev.target));
    if (!inside) filterDrawer.classList.add("translate-x-full");
  });

  if (searchBar) {
    let t;
    searchBar.addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(() => {
        page = 1;
        const st = getFilterState();
        let filtered = applyFilterLogic(allProducts, st);
        filtered = sortProducts(filtered, st.sort);
        lastRendered = filtered;
        renderProducts(lastRendered, page);
      }, 300);
    });
  }

  if (sortSelect) {
    sortSelect.addEventListener("change", () => {
      page = 1;
      const st = getFilterState();
      let filtered = applyFilterLogic(allProducts, st);
      filtered = sortProducts(filtered, st.sort);
      lastRendered = filtered;
      renderProducts(lastRendered, page);
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (filterDrawer)
        filterDrawer.classList.add("translate-x-full");
      if (miniCart) miniCart.classList.add("translate-x-full");
    }
  });

  // ---------- Load products from DB ----------
  async function loadProductsFromDB() {
  const { data, error } = await supabase
    .from("products")
    .select("*");

  if (error) {
    console.error("Error loading products:", error);
    return [];
  }

  console.log("Products loaded:", data);
  return data;
}


  async function fetchProductsFromDB() {
    const { data, error } = await api
      .from("products")
      .select(
        "id,name,price,unit,brand,tags,rating,image_url,category_slug"
      )
      .order("id", { ascending: true });

    if (error) {
      console.error("products fetch error:", error.message);
      return [];
    }

    return (data || []).map((row) => {
      const tags = Array.isArray(row.tags) ? row.tags : [];
      const brandRaw = row.brand || "";
      const brandKey = brandRaw.toLowerCase().replace(/\s+/g, "");

      return {
        id: row.id,
        name: row.name,
        price: Number(row.price || 0),
        unit: row.unit || "",
        brandRaw,
        brandKey, // used for filter-brand (farmfresh, organicvalley, etc.)
        tags,
        rating: row.rating ? Number(row.rating) : 4,
        image: row.image_url,
        category: row.category_slug || "",
      };
    });
  }

  async function initPage() {
    await loadCurrentUser();

    // load all products from DB
    allProducts = await fetchProductsFromDB();
    lastRendered = sortProducts(allProducts, "pop");
    renderProducts(lastRendered, page);

    // load DB cart
    await reloadMiniCart();

    // Expose helper (optional)
    window.__dealDropCategory = window.__dealDropCategory || {};
    window.__dealDropCategory.addToCartById = (id) => addToCart(id);

    console.info("Category page fully DB-driven & cart in DB.");
  }

  await initPage();
})();
</script>



</body>
</html>
