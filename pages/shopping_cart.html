<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - DealDrop</title>
    <link rel="stylesheet" href="../css/main.css">
  
  
  </head>
<body class="bg-background text-text-primary">
    <!-- Navigation Header -->
    <!-- Navigation Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-background/95 backdrop-blur-sm border-b border-surface">
        <nav class="container mx-auto px-4 py-4 flex items-center justify-between">

           <!-- BIG Logo (Perfect Fit, Left Aligned) -->
        <div class="flex items-center space-x-3 shrink-0">
            <img src="https://i.postimg.cc/Hsx8pxHb/Screenshot-2025-11-13-165233.png"
                 alt="DealDrop Logo"
                 class="h-16 w-auto object-contain block select-none" /> <span class="text-xl md:text-2xl font-bold text-white tracking-wide hover:text-[#4de8ba] transition-colors duration-300">
    DealDrop
  </span>
        </div>

                <!-- Search Bar -->
<div class="hidden md:flex flex-1 max-w-2xl mx-8">
    <div class="relative w-full">

        <!-- Input -->
        <input type="text" 
            placeholder="Search for fresh produce, organic foods..."
            id="searchInput"
            class="w-full pl-14 pr-4 py-3 rounded-full bg-[#082219] text-white placeholder-gray-400 
                   border border-[#0f4f35]/60 shadow-[0_0_8px_rgba(0,255,170,0.15)]
                   focus:border-[#14f5a3] focus:shadow-[0_0_18px_rgba(20,245,163,0.45)]
                   transition-all duration-300 outline-none">

        <!-- Search Icon -->
        <svg 
            class="absolute left-5 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[#4de8ba]"
            fill="none" stroke="currentColor" 
            viewBox="0 0 24 24"
        >
            <path 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                stroke-width="2" 
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            ></path>
        </svg>

        <!-- Search Suggestions Dropdown -->
        <div 
            id="searchSuggestions" 
            class="absolute top-full left-0 right-0 bg-[#0b2d22] border border-[#124736]/50 
                   rounded-xl mt-2 shadow-[0_0_20px_rgba(18,245,159,0.15)] hidden backdrop-blur-xl"
        >
            <div class="p-4 text-white">
                <div class="text-sm text-gray-300 mb-3 font-semibold tracking-wide">Popular Searches</div>

                <div class="space-y-2">

                    <!-- Suggestion 1 -->
                    <div class="flex items-center space-x-3 p-2 rounded-lg cursor-pointer
                                hover:bg-[#103829] transition-colors duration-200">
                        <img 
                            src="https://images.unsplash.com/photo-1675324918825-cd13b33a35b6" 
                            alt="Fresh organic tomatoes" 
                            class="w-8 h-8 rounded object-cover"
                        >
                        <span class="text-gray-100">Organic Tomatoes</span>
                    </div>

                    <!-- Suggestion 2 -->
                    <div class="flex items-center space-x-3 p-2 rounded-lg cursor-pointer
                                hover:bg-[#103829] transition-colors duration-200">
                        <img 
                            src="https://images.unsplash.com/photo-1676454954482-3a7d43f780e3" 
                            alt="Fresh leafy greens and vegetables" 
                            class="w-8 h-8 rounded object-cover"
                        >
                        <span class="text-gray-100">Fresh Greens</span>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center space-x-6">
                <a href="homepage.html" class="text-secondary font-semibold">Home</a>

                <a href="categories_page.html" class="text-text-secondary hover:text-secondary transition-colors duration-300">
                    Categories
                </a>

                <!-- Cart Icon with Badge -->
                <a href="shopping_cart.html" class="relative">
    <svg class="w-6 h-6 text-text-secondary hover:text-secondary transition-colors duration-300" 
         fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0h9"/>
    </svg>

    <!--  Glowing Dot (initially hidden) -->
    <span id="cartDot"
          class="hidden absolute -top-1 -right-1 w-3 h-3 rounded-full 
                 bg-[#12f59f] shadow-[0_0_8px_#12f59f,0_0_12px_#12f59f]">
    </span>
</a>


                <!-- Account -->
                <a href="user_account_dashboard.html" class="text-text-secondary hover:text-secondary transition-colors duration-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width="2" 
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        ></path>
                    </svg>
                </a>
            </div>

            <!-- Mobile Menu Button -->
            <button class="md:hidden text-text-primary" id="mobileMenuBtn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path 
                        stroke-linecap="round" 
                        stroke-linejoin="round" 
                        stroke-width="2" 
                        d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
            </button>

        </nav>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="md:hidden bg-surface border-t border-surface hidden">
            <div class="px-4 py-4 space-y-4">

                <div class="relative">
                    <input 
                        type="text" 
                        placeholder="Search products..." 
                        class="input-field w-full pl-10 pr-4 py-2"
                    >
                    <svg 
                        class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-text-secondary" 
                        fill="none" stroke="currentColor" 
                        viewBox="0 0 24 24"
                    >
                        <path 
                            stroke-linecap="round" 
                            stroke-linejoin="round" 
                            stroke-width="2" 
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path>
                    </svg>
                </div>

                <a href="homepage.html" class="block text-secondary font-semibold py-2">Home</a>
                <a href="categories_page.html" class="block text-text-secondary py-2">Categories</a>
                <a href="shopping_cart.html" class="block text-text-secondary py-2">Cart (3)</a>
                <a href="user_account_dashboard.html" class="block text-text-secondary py-2">Account</a>

            </div>
        </div>

    </header>

    <main class="pt-28 pb-20">

  <div class="container mx-auto px-4">

    <!-- Breadcrumb -->
    <nav class="text-sm text-text-secondary mb-4 flex items-center gap-2">
      <a href="homepage.html" class="hover:text-secondary transition">Home</a>
      <span class="opacity-50">/</span>
      <span class="text-text-primary">Shopping Cart</span>
    </nav>

    <!-- Page Title -->
    <div class="mb-10">
      <h1 class="text-4xl font-bold mb-2">Your Cart</h1>
      <p class="text-lg text-text-secondary">Review items, adjust quantities & apply offers.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

      <!-- LEFT SECTION ‚Äî CART ITEMS -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Free delivery -->
        <div class="card flex items-center gap-4 p-5 border border-secondary/20 bg-gradient-to-r from-secondary/10 to-accent/10 rounded-xl">
          <div class="w-12 h-12 rounded-full bg-secondary flex items-center justify-center font-bold text-black">‚úì</div>
          <div>
            <h3 class="font-semibold text-secondary">Free Delivery Unlocked</h3>
            <p class="text-text-secondary text-sm">You're eligible for free same-day delivery.</p>
          </div>
        </div>

        <!-- CART ITEMS -->
        <div id="cartItems" class="space-y-4"></div>

        <!-- Saved for Later Section -->
        <section id="savedForLaterSection" class="hidden mt-10">
          <h2 class="text-2xl font-semibold mb-4">Saved for Later</h2>
          <div id="savedForLater" class="space-y-4"></div>
        </section>

      </div>

      <!-- RIGHT SECTION ‚Äî ORDER SUMMARY -->
      <aside class="lg:col-span-1">
        <div class="sticky top-28">

          <div class="card p-6 rounded-xl shadow-lg border border-surface">

            <h2 class="text-xl font-semibold mb-5">Order Summary</h2>

            <!-- PROMO INPUT -->
            <div class="mb-5">
              <label class="text-sm text-text-secondary">Promo Code</label>
              <div class="flex gap-2 mt-1">
                <input id="promoInput" class="input-field flex-1 rounded-lg px-3 py-2 bg-surface border border-surface focus:border-secondary outline-none transition" placeholder="Enter promo code">
                <button id="promoApply" class="btn-secondary px-4">Apply</button>
              </div>
              <p id="promoMessage" class="text-success text-sm mt-2 hidden">Promo applied successfully!</p>
              <p id="promoInvalid" class="text-error text-sm mt-2 hidden">Invalid promo code!</p>
            </div>

            <!-- PRICE BREAKDOWN -->
            <div class="space-y-3 mb-5 text-sm">
              <div class="flex justify-between text-text-secondary">
                <span>Subtotal</span><span id="subtotal">‚Çπ0</span>
              </div>

              <div id="discountRow" class="flex justify-between text-success hidden">
                <span>Discount</span><span id="discountValue">-‚Çπ0</span>
              </div>

              <div class="flex justify-between text-text-secondary">
                <span>GST (18%)</span><span id="tax">‚Çπ0</span>
              </div>

              <hr class="border-surface my-2">

              <div class="flex justify-between text-xl font-bold">
                <span>Total</span><span id="total">‚Çπ0</span>
              </div>
            </div>

            <!-- Buttons -->
            <a href="checkout_process.html" class="btn-primary w-full text-center block mb-3 py-3 text-lg">
              Proceed to Checkout
            </a>
            <button class="btn-secondary w-full py-3 text-lg">Express Checkout</button>

          </div>

          <p class="mt-5 text-secondary text-sm hover:text-accent cursor-pointer flex items-center gap-1">
            ‚Üê Continue Shopping
          </p>

        </div>
      </aside>

    </div>
  </div>
</main>

<!-- Undo Toast -->
<div id="undoToast"
     class="fixed bottom-6 right-6 card p-4 bg-surface border border-secondary/25 shadow-xl 
            transform translate-y-full transition-all duration-300 rounded-lg w-80">
  <div class="flex justify-between items-center">
    <p id="undoMessage" class="text-sm"></p>
    <button id="undoBtn" class="text-secondary font-semibold hover:text-accent">Undo</button>
  </div>
</div>
<!-- PROMO OFFERS SECTION -->
<div class="card p-5 mb-6 rounded-xl border border-secondary/20">

  <h2 class="text-xl font-semibold mb-3">Available Offers</h2>
  <p class="text-text-secondary text-sm mb-4">
    Choose from the best deals & apply them instantly.
  </p>

  <div class="space-y-3">

    <!-- OFFER 1 -->
    <div class="flex items-start justify-between p-4 rounded-lg bg-surface/60 border border-surface hover:border-secondary/40 transition cursor-pointer">
      <div>
        <h3 class="font-semibold text-secondary">WELCOME10</h3>
        <p class="text-text-secondary text-sm">Get 10% OFF on your first order. No minimum purchase.</p>
      </div>
      <button class="applyOffer btn-secondary px-4 py-1 mt-1" data-code="welcome10">Apply</button>
    </div>

    <!-- OFFER 2 -->
    <div class="flex items-start justify-between p-4 rounded-lg bg-surface/60 border border-surface hover:border-secondary/40 transition cursor-pointer">
      <div>
        <h3 class="font-semibold text-secondary">FRESH15</h3>
        <p class="text-text-secondary text-sm">Flat 15% OFF on fresh vegetables.</p>
      </div>
      <button class="applyOffer btn-secondary px-4 py-1 mt-1" data-code="fresh15">Apply</button>
    </div>

    <!-- OFFER 3 -->
    <div class="flex items-start justify-between p-4 rounded-lg bg-surface/60 border border-surface hover:border-secondary/40 transition cursor-pointer">
      <div>
        <h3 class="font-semibold text-secondary">ORGANIC20</h3>
        <p class="text-text-secondary text-sm">20% OFF on all organic products above ‚Çπ499.</p>
      </div>
      <button class="applyOffer btn-secondary px-4 py-1 mt-1" data-code="organic20">Apply</button>
    </div>

  </div>
</div>

     <!-- Footer -->
<footer class="relative bg-gradient-to-br from-[#0a0a0a] via-[#111111] to-[#1a1a1a] text-gray-300 py-20 overflow-hidden">
  <!-- Subtle background glow -->
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(18,245,159,0.15),transparent_70%)]"></div>
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(18,245,159,0.1),transparent_70%)]"></div>

  <div class="relative z-10 container mx-auto px-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-12 border-b border-gray-700 pb-12">
      
      <!-- Company Info -->
      <div>
        <div class="flex items-center space-x-3 mb-6">
          <div class="w-12 h-12 bg-[#12f59f] rounded-full flex items-center justify-center text-black font-bold text-xl shadow-[0_0_20px_rgba(18,245,159,0.5)]">D</div>
          <span class="text-3xl font-bold text-white">DealDrop</span>
        </div>
        <p class="text-gray-400 mb-6 leading-relaxed">
          Freshness delivered. Experience premium groceries with the simplicity and speed of DealDrop.
        </p>

        <!-- Social Media Icons -->
        <div class="flex space-x-5">
          <!-- Facebook -->
          <a href="#" class="group transition-all duration-300" aria-label="Facebook">
            <svg class="w-7 h-7 text-gray-400 group-hover:text-[#12f59f] transition" fill="currentColor" viewBox="0 0 24 24">
              <path d="M22.675 0h-21.35C.596 0 0 .592 0 1.324v21.352C0 23.406.596 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.658-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.314h3.587l-.467 3.622h-3.12V24h6.116C23.404 24 24 23.406 24 22.676V1.324C24 .592 23.404 0 22.675 0z"/>
            </svg>
          </a>

          <!-- Instagram -->
          <a href="#" class="group transition-all duration-300" aria-label="Instagram">
            <svg class="w-7 h-7 text-gray-400 group-hover:text-[#f56040] transition" fill="currentColor" viewBox="0 0 24 24">
              <path d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5A4.25 4.25 0 0 0 20.5 16.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5zm8.75 2.25a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5zM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0 1.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z"/>
            </svg>
          </a>
        </div>
      </div>

      <!-- Quick Links -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Quick Links</h3>
        <ul class="space-y-3">
          <li><a href="homepage.html" class="hover:text-[#12f59f] transition">Home</a></li>
          <li><a href="categories_page.html" class="hover:text-[#12f59f] transition">Categories</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">About Us</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Contact</a></li>
        </ul>
      </div>

      <!-- Customer Service -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Customer Service</h3>
        <ul class="space-y-3">
          <li><a href="#" class="hover:text-[#12f59f] transition">Help Center</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Shipping Info</a></li>
          <li><a href="#" class="hover:text-[#12f59f] transition">Returns</a></li>
          <li><a href="user_account_dashboard.html" class="hover:text-[#12f59f] transition">My Account</a></li>
        </ul>
      </div>

      <!-- Contact Info -->
      <div>
        <h3 class="text-lg font-semibold text-white mb-6">Contact Info</h3>
        <ul class="space-y-3">
          <li>üìû <span class="text-gray-400">91+8169963185</span></li>
          <li>‚úâÔ∏è <span class="text-gray-400">botfather@gmail.com</span></li>
          <li>üìç <span class="text-gray-400">Kandivali (E),Mumbai</span></li>
        </ul>
      </div>
    </div>

    <!-- Bottom Section -->
    <div class="pt-8 text-center text-sm text-gray-500">
      <p>¬© 2025 DealDrop ‚Äî Designed with üíö Developed by ~Sahil .</p>
    </div>
  </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../js/dealdrop.js"></script>
<script>
(async () => {
  // ===== REQUIRE supabaseClient FROM dealdrop.js =====
  if (typeof supabaseClient === "undefined") {
    console.error("supabaseClient not found. Make sure dealdrop.js is loaded BEFORE this script.");
    return;
  }

  const api = supabaseClient;
  const TAX_RATE = 0.18;               // 18% GST
  const SAVED_KEY = "dealdrop_saved_items";

  // ---------- Small helpers ----------
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const formatINR = n =>
    "‚Çπ" + Number(n || 0).toLocaleString("en-IN", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  const safe = v => (v == null ? "" : String(v));
  const escapeHtml = s =>
    safe(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");

  // ---------- DOM elements ----------
  const cartItemsContainer     = $("#cartItems");
  const savedForLaterSection   = $("#savedForLaterSection");
  const savedForLaterContainer = $("#savedForLater");
  const subtotalEl             = $("#subtotal");
  const taxEl                  = $("#tax");
  const totalEl                = $("#total");
  const discountRow            = $("#discountRow");
  const discountValueEl        = $("#discountValue");
  const promoInput             = $("#promoInput");
  const promoApplyBtn          = $("#promoApply");
  const promoMessage           = $("#promoMessage");
  const promoInvalid           = $("#promoInvalid");
  const undoToast              = $("#undoToast");
  const undoMessage            = $("#undoMessage");
  const undoBtn                = $("#undoBtn");
  const headerBadge            =
    document.getElementById("cartCount") ||
    document.getElementById("cart-count") ||
    document.querySelector(".cart-badge");

  // ---------- Auth + cart state ----------
  let currentUser = null;       // supabase auth user
  let cartId      = null;       // user_cart.id
  let cartItems   = [];         // [{cartItemId, productId, quantity, ...productFields}]
  let savedItems  = JSON.parse(localStorage.getItem(SAVED_KEY) || "{}");
  let lastRemoved = null;
  let undoTimer   = null;

  // ---------- AUTH HELPERS ----------
  async function loadCurrentUser() {
    const { data, error } = await api.auth.getUser();
    if (error) {
      console.warn("getUser error:", error.message);
      return null;
    }
    currentUser = data?.user || null;
    return currentUser;
  }

  // Make sure a row exists in public.users (to satisfy fk_cart_user)
  async function ensureAppUser() {
    if (!currentUser) return null;

    const email =
      currentUser.email || null;
    const full_name =
      currentUser.user_metadata?.full_name ||
      currentUser.user_metadata?.name ||
      null;
    const username =
      currentUser.user_metadata?.username ||
      currentUser.user_metadata?.preferred_username ||
      (email ? email.split("@")[0] : null);
    const provider =
      currentUser.app_metadata?.provider || "email";

    const { error } = await api
      .from("users")
      .upsert(
        {
          id: currentUser.id,
          email,
          full_name,
          username: username ? username.toLowerCase() : null,
          provider,
          updated_at: new Date().toISOString(),
        },
        { onConflict: "id" }
      );

    if (error) {
      console.error("users upsert error:", error.message);
    }
  }

  // Ensure there is one cart row for this user
  async function ensureCart() {
    if (!currentUser) return null;
    if (cartId) return cartId;

    await ensureAppUser(); // üîë fixes fk_cart_user 409

    // Look for existing cart
    const { data: existing, error } = await api
      .from("user_cart")
      .select("id")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if (error) {
      console.error("user_cart select error:", error.message);
    }

    if (existing) {
      cartId = existing.id;
      return cartId;
    }

    // Create new cart
    const { data: created, error: insertErr } = await api
      .from("user_cart")
      .insert({ user_id: currentUser.id })
      .select("id")
      .single();

    if (insertErr) {
      console.error("Cart create error:", insertErr.message);
      return null;
    }

    cartId = created.id;
    return cartId;
  }

  // ---------- CART ITEMS FROM DB ----------
  async function loadCartItems() {
    if (!currentUser) {
      cartItems = [];
      renderCart();
      return;
    }

    const id = await ensureCart();
    if (!id) {
      cartItems = [];
      renderCart();
      return;
    }

    // Join user_cart_items with products
    const { data, error } = await api
      .from("user_cart_items")
      .select(`
        id,
        product_id,
        quantity,
        products (
          id,
          name,
          price,
          unit,
          brand,
          tags,
          rating,
          image_url,
          category_slug
        )
      `)
      .eq("cart_id", id);

    if (error) {
      console.error("user_cart_items error:", error.message);
      cartItems = [];
      renderCart();
      return;
    }

    cartItems = (data || []).map(row => {
      const p = row.products || {};
      const tags = Array.isArray(p.tags) ? p.tags : [];
      return {
        cartItemId: row.id,
        productId : row.product_id,
        quantity  : Number(row.quantity || 1),
        name      : p.name,
        price     : Number(p.price || 0),
        unit      : p.unit || "",
        brand     : p.brand || "",
        tags,
        rating    : p.rating ? Number(p.rating) : 4,
        image     : p.image_url,
        category  : p.category_slug || ""
      };
    });

    renderCart();
  }

  async function updateCartItemQuantity(cartItemId, newQty) {
    if (!cartItemId || !cartId) return;
    if (newQty <= 0) {
      await removeCartItem(cartItemId);
      return;
    }

    const { error } = await api
      .from("user_cart_items")
      .update({ quantity: newQty, updated_at: new Date().toISOString() })
      .eq("id", cartItemId);

    if (error) {
      console.error("update quantity error:", error.message);
      return;
    }

    await loadCartItems();
  }

  async function removeCartItem(cartItemId) {
    const idx = cartItems.findIndex(it => it.cartItemId === cartItemId);
    if (idx === -1) return;

    lastRemoved = { ...cartItems[idx] };

    const { error } = await api
      .from("user_cart_items")
      .delete()
      .eq("id", cartItemId);

    if (error) {
      console.error("remove item error:", error.message);
      return;
    }

    await loadCartItems();
    showUndoToast(`${lastRemoved.name} removed`);
  }

  async function undoRemove() {
    if (!lastRemoved || !cartId) return;

    const { error } = await api
      .from("user_cart_items")
      .insert({
        cart_id   : cartId,
        product_id: lastRemoved.productId,
        quantity  : lastRemoved.quantity || 1
      });

    if (error) {
      console.error("undo insert error:", error.message);
      return;
    }

    lastRemoved = null;
    await loadCartItems();
  }

  // ---------- RENDER HELPERS ----------
  function updateHeaderBadge() {
    if (!headerBadge) return;
    const count = cartItems.reduce(
      (sum, it) => sum + Number(it.quantity || 0),
      0
    );
    headerBadge.textContent = count;
  }

  function updateOrderSummary() {
    const subtotal = cartItems.reduce(
      (s, it) => s + Number(it.price) * Number(it.quantity || 1),
      0
    );
    const tax   = subtotal * TAX_RATE;
    const total = subtotal + tax;

    if (subtotalEl) subtotalEl.textContent = formatINR(subtotal);
    if (taxEl)      taxEl.textContent      = formatINR(tax);
    if (totalEl)    totalEl.textContent    = formatINR(total);
  }

  function renderCart() {
    cartItemsContainer.innerHTML = "";

    if (!cartItems.length) {
      cartItemsContainer.innerHTML =
        `<div class="card p-6 text-center text-text-secondary">
           Your cart is empty.
           <a href="categories_page.html" class="text-secondary">Browse products</a>
         </div>`;
      updateOrderSummary();
      updateHeaderBadge();
      renderSavedForLater();
      return;
    }

    cartItems.forEach(item => {
      const idAttr = item.cartItemId;
      const qty    = Number(item.quantity || 1);
      const itemTotal = item.price * qty;

      const card = document.createElement("div");
      card.className = "card cart-item";
      card.dataset.itemId = idAttr;

      card.innerHTML = `
        <div class="flex flex-col md:flex-row gap-4">
          <div class="w-full md:w-32 h-32 rounded-lg overflow-hidden flex-shrink-0">
            <img src="${escapeHtml(item.image || "")}"
                 alt="${escapeHtml(item.name || "")}"
                 class="w-full h-full object-cover" loading="lazy">
          </div>

          <div class="flex-1">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h3 class="text-lg font-semibold">${escapeHtml(item.name)}</h3>
                <p class="text-text-secondary text-sm">
                  ${escapeHtml(item.brand || "")} ¬∑ ${escapeHtml(item.unit || "")}
                </p>
                <div class="flex items-center space-x-2 mt-1">
                  ${(item.tags || []).slice(0,3).map(
                    t => `<span class="bg-secondary/20 text-secondary text-xs px-2 py-1 rounded">
                            ${escapeHtml(t)}
                          </span>`
                  ).join(" ")}
                  <span class="text-text-secondary text-xs">
                    ${escapeHtml(item.category || "")}
                  </span>
                </div>
              </div>

              <button class="text-text-secondary hover:text-error transition-colors duration-300 remove-item"
                      data-item-id="${idAttr}" title="Remove">
                ‚úï
              </button>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="flex items-center border border-surface rounded-lg">
                  <button class="p-2 hover:bg-surface quantity-btn"
                          data-action="decrease" data-item-id="${idAttr}">-</button>
                  <span class="px-4 py-2 font-semibold quantity-display"
                        data-item-id="${idAttr}">${qty}</span>
                  <button class="p-2 hover:bg-surface quantity-btn"
                          data-action="increase" data-item-id="${idAttr}">+</button>
                </div>
                <button class="text-text-secondary hover:text-secondary text-sm save-later"
                        data-item-id="${idAttr}">
                  Save for Later
                </button>
              </div>

              <div class="text-right">
                <div class="text-lg font-bold item-total"
                     data-item-id="${idAttr}">${formatINR(itemTotal)}</div>
                <div class="text-text-secondary text-sm">
                  ${formatINR(item.price)} each
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      cartItemsContainer.appendChild(card);
    });

    updateOrderSummary();
    updateHeaderBadge();
  }

  // ---------- SAVED FOR LATER (localStorage only) ----------
  function renderSavedForLater() {
    if (!savedForLaterSection || !savedForLaterContainer) return;
    const keys = Object.keys(savedItems || {});
    if (!keys.length) {
      savedForLaterSection.style.display = "none";
      return;
    }
    savedForLaterSection.style.display = "block";
    savedForLaterContainer.innerHTML = "";

    keys.forEach(k => {
      const it = savedItems[k];
      const div = document.createElement("div");
      div.className = "card flex items-center gap-4";
      div.innerHTML = `
        <div class="w-16 h-16 overflow-hidden rounded">
          <img src="${escapeHtml(it.image || "")}"
               class="w-full h-full object-cover">
        </div>
        <div class="flex-1">
          <div class="font-semibold">${escapeHtml(it.name)}</div>
          <div class="text-text-secondary text-sm">${formatINR(it.price)}</div>
        </div>
        <div>
          <button class="btn-primary add-saved-back" data-id="${k}">Add</button>
        </div>`;
      savedForLaterContainer.appendChild(div);
    });
  }

  // ---------- UNDO TOAST ----------
  function showUndoToast(msg) {
    if (!undoToast) return;
    undoMessage.textContent = msg;
    undoToast.classList.remove("translate-y-full");
    undoToast.style.transform = "translateY(0)";
    if (undoTimer) clearTimeout(undoTimer);
    undoTimer = setTimeout(() => {
      hideUndoToast();
      lastRemoved = null;
    }, 5000);
  }

  function hideUndoToast() {
    if (!undoToast) return;
    undoToast.style.transform = "translateY(100%)";
  }

  // ---------- PROMO CODES ----------
  function applyPromo(code) {
    const codes = { welcome10: 0.10, fresh15: 0.15, organic20: 0.20 };
    const factor = codes[code.toLowerCase()];
    if (!factor) {
      promoInvalid?.classList.remove("hidden");
      setTimeout(() => promoInvalid?.classList.add("hidden"), 2500);
      return;
    }

    const subtotal = cartItems.reduce(
      (s, it) => s + Number(it.price) * Number(it.quantity || 1),
      0
    );
    const discountValue = subtotal * factor;
    const discountedSubtotal = Math.max(0, subtotal - discountValue);
    const tax = discountedSubtotal * TAX_RATE;
    const total = discountedSubtotal + tax;

    if (discountRow && discountValueEl) {
      discountRow.classList.remove("hidden");
      discountValueEl.textContent = "-" + formatINR(discountValue);
    }
    if (subtotalEl) subtotalEl.textContent = formatINR(discountedSubtotal);
    if (taxEl)      taxEl.textContent      = formatINR(tax);
    if (totalEl)    totalEl.textContent    = formatINR(total);

    promoMessage?.classList.remove("hidden");
    setTimeout(() => promoMessage?.classList.add("hidden"), 2500);
    if (promoInput) promoInput.disabled = true;
    if (promoApplyBtn) {
      promoApplyBtn.disabled = true;
      promoApplyBtn.textContent = "Applied";
    }
  }

  // ---------- EVENT HANDLERS ----------
  document.addEventListener("click", async (e) => {
    // quantity buttons
    const qbtn = e.target.closest(".quantity-btn");
    if (qbtn) {
      const id = Number(qbtn.dataset.itemId);
      const action = qbtn.dataset.action;
      const item = cartItems.find(it => it.cartItemId === id);
      if (!item) return;

      let newQty = Number(item.quantity || 1);
      if (action === "increase") newQty++;
      else if (action === "decrease") newQty = Math.max(1, newQty - 1);

      await updateCartItemQuantity(id, newQty);
      return;
    }

    // remove item
    const rem = e.target.closest(".remove-item");
    if (rem) {
      const id = Number(rem.dataset.itemId);
      await removeCartItem(id);
      return;
    }

    // save for later
    const sfl = e.target.closest(".save-later");
    if (sfl) {
      const id = Number(sfl.dataset.itemId);
      const item = cartItems.find(it => it.cartItemId === id);
      if (!item) return;

      savedItems[id] = {
        name: item.name,
        price: item.price,
        image: item.image,
        quantity: item.quantity
      };
      localStorage.setItem(SAVED_KEY, JSON.stringify(savedItems));
      await removeCartItem(id);
      renderSavedForLater();
      return;
    }

    // undo button
    if (e.target.closest("#undoBtn")) {
      await undoRemove();
      hideUndoToast();
      return;
    }

    // add saved back
    const addSaved = e.target.closest(".add-saved-back");
    if (addSaved) {
      const key = addSaved.dataset.id;
      const it = savedItems[key];
      if (!it || !cartId) return;

      // Insert new cart item
      const { error } = await api
        .from("user_cart_items")
        .insert({
          cart_id   : cartId,
          product_id: it.productId || it.product_id || null, // if you store it later
          quantity  : it.quantity || 1
        });

      if (error) console.error("add saved back error:", error.message);

      delete savedItems[key];
      localStorage.setItem(SAVED_KEY, JSON.stringify(savedItems));

      await loadCartItems();
      renderSavedForLater();
      return;
    }

    // apply offer cards
    const offerBtn = e.target.closest(".applyOffer");
    if (offerBtn) {
      const code = offerBtn.dataset.code;
      if (promoInput) promoInput.value = code;
      setTimeout(() => promoApplyBtn?.click(), 150);
    }
  });

  if (promoApplyBtn) {
    promoApplyBtn.addEventListener("click", () => {
      const code = promoInput?.value || "";
      if (!code) return;
      applyPromo(code);
    });
  }

  // ---------- INIT ----------
  async function init() {
    await loadCurrentUser();

    if (!currentUser) {
      // not logged in ‚Üí show empty cart message
      cartItemsContainer.innerHTML =
        `<div class="card p-6 text-center text-text-secondary">
           Please <a href="login.html" class="text-secondary">login</a> to view your cart.
         </div>`;
      return;
    }

    await ensureCart();
    await loadCartItems();
    renderSavedForLater();
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>



</body>
</html>
